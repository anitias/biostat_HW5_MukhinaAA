---
title: "Биостатистика, дз 5"
author: "Мухина А.А."
date: "2024-04-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Импортируем библиотеки

```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(tidyverse)
library(car)
library(survival)
library(ggsurvfit)
library(survminer)
```

```{r}
setwd('C:/Users/79169/Desktop/Биостатистика, R/дз')
```

Загружаем файл

```{r}
breast_cancer <- read.csv('wisconsin_breast_cancer.csv')
```

```{r}
head(breast_cancer)
```
```{r}
str(breast_cancer)
```
В колонке diagnosis содержится информация об опухоли (M = злокачественная, B = доброкачественная). Трансформируем содержимое этой колонки в фактор

```{r}
breast_cancer <- breast_cancer %>% 
  mutate(diagnosis = as.factor(diagnosis))
```

***

## Задание 1

Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

*** 

Для построения модели, описывающей связь между средним радиусом опухоли и средней площадью, средним периметром и средней симметричностью применим линейную регрессию, выбор можно обосновать простотой интерпретации, линейностью предполагаемой взаимосвязи, широким применением и эффективностью модели. 

Н0 - нет взаимосвзи между средним радиусом опухоли и средней площадью, средним периметром и средней симметричностью

Н1 - есть взаимосвязь между средним радиусом опухоли и средней площадью, средним периметром и средней симметричностью

Уроовень значимости возьмем 0.05

```{r}
model <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = breast_cancer)

summary(model)
```
Из результатов анализа следует, что модель линейной регрессии, описывающая связь между средним радиусом опухоли и средней площадью, средним периметром и средней симметричностью, является статистически значимой. Каждый из предикторов - средняя площадь, средний периметр и средняя симметричность - оказывает статистически значимое влияние на средний радиус опухоли, то есть мы отклоняем нулевую гипотезу и принимаем альтернативную.

Однако, важно учитывать ограничения линейной регрессии, такие как необходимость выполнения предположений о линейности и нормальности распределения остатков для достижения правильных выводов. Проверим эти условия.

Вначале проверим линейную взаимосвязь между факторами

```{r}
ggplot(breast_cancer, aes(x = radius_mean, y = area_mean)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Взаимосвязь между средним радиусом и средней площадью опухоли",
       x = 'Средний радиус опухоли',
       y = 'Средняя площадь опухоли')
```
```{r}
ggplot(breast_cancer, aes(x = radius_mean, y = perimeter_mean)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Взаимосвязь между средним радиусом и средним периметром опухоли",
       x = 'Средний радиус опухоли',
       y = 'Средний периметр опухоли')
```
```{r}
ggplot(breast_cancer, aes(x = radius_mean, y = symmetry_mean)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Взаимосвязь между средним радиусом и средней симметричностью опухоли",
       x = 'Средний радиус опухоли',
       y = 'Средняя симметричность опухоли')
```

Визуально эти взаимосвязи можно охарактеризовать как линейные.

Теперь проверим нормальность распределения остатков

```{r}
qqPlot(residuals(model))
```
Часть точек ложится на регрессионную прямую, напоминая нормальное распределение, однако нельзя не обратить внимание на левую часть распределения, которая отклоняется от регрессионной прямой.

Проведем также статистический тест.

```{r}
shapiro.test(residuals(model))
```
Согласно тесту Шапиро-Уилка, распреление остатков отлично от нормального.


```{r}
plot(model, which = 1)
```
По данному графику также можно отметить не совсем равномерное распределение.


В связи с вывленными особенностями распределения остатков к результатам модели нужно отнестись с настороженностью и, в идеале, выбрать какую-нибудь еще модель, для проверки взаимосвязи факторов.


***

## Задание 2

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

***

Добавим новый столбец со злокачественностью опухоли

```{r}
breast_cancer$malignancy <- ifelse(breast_cancer$diagnosis == 'M', 1, 0)
```

Для построения модели, описывающей связь между вероятностью возникновения злокачественной опухоли и средним радиусом, средней площадью и средней текстурой применим логистическую регрессию, так как злокачественность - бинарная категория.

Н0 - нет взаимосвзи между вероятностью возникновения злокачественной опухоли и средним радиусом, средней площадью и средней текстурой

Н1 - есть взаимосвязь между вероятностью возникновения злокачественной опухоли и средним радиусом, средней площадью и средней текстурой

Уроовень значимости возьмем 0.05

```{r}
model_2 <- glm(malignancy ~ radius_mean + area_mean + texture_mean, data = breast_cancer, family = "binomial")

summary(model_2)
```
radius_mean, area_mean и texture_mean не оказывают статистически значимого влияния на вероятность злокачественности опухоли при уровне значимости 0.05, так как p-value для каждого из них выше 0.05. Переменная texture_mean оказывается самой важной среди всех предикторов, так как имеет наибольший коэффициент и самый низкий p-value.

Итак, на основе анализа логистической регрессии, можно сделать вывод о том, что переменные radius_mean и area_mean не оказывают статистически значимого влияния на злокачественность опухоли, в то время как переменная texture_mean имеет статистически значимое влияние и может играть важную роль в прогнозировании злокачественности опухолей.


Так же проведем экспоненцирование коэффициентов логистической модели

```{r}
exp(coef(model_2))
```
Отсюда можно сделать вывод, что увеличение значения текстуры на единицу увеличивает вероятность злокачественности опухоли в ~1.23 раза (остальные факторы статистически не значимы, поэтому анализировать не будем)


Перейдем к визуализации.

```{r}
breast_cancer %>%
    ggplot(aes(x = radius_mean, y = malignancy)) +
    geom_point() +
    labs(title = "Злокачественность и средний радиус опухоли",
      x = "Средний радиус опухоли",
      y = "Злокачественность") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial"))
```
```{r}
breast_cancer %>%
    ggplot(aes(x = area_mean, y = malignancy)) +
    geom_point() +
    labs(title = "Злокачественность и средняя площадь опухоли",
      x = "Средняя площадь опухоли",
      y = "Злокачественность") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial"))
```
```{r}
breast_cancer %>%
    ggplot(aes(x = texture_mean, y = malignancy)) +
    geom_point() +
    labs(title = "Злокачественность и средняя текстура опухоли",
      x = "Средняя текстура опухоли",
      y = "Злокачественность") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial"))
```

Создадим модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}
model_3 <- glm(malignancy ~ radius_mean * area_mean * texture_mean, data = breast_cancer, family = "binomial")

summary(model_3)
```
В данной модели p-value для всех факторови и их сочетаний больше установленного уровня значимости, в соотвествии с результатами данной модели, мы не можем отклонить нулевую гипотезу.


***

## Задание 3

Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

Изучите работу функций Surv(), survfit() и ggsurvplot():

Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.

Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.

С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

***

Загружаем датасет

```{r}
lung <- survival::lung

head(lung)
```
Создадим переменную event

```{r}
lung$event <- ifelse(lung$status == 2,1,0)
```

Отфильтруем только пациентов, у которых произошло интересующее событие

```{r}
lung_filtered <- filter(lung,lung$event == 1)
```


Построим кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним).

```{r}
lung_survfit <- survfit(Surv(time, event) ~ sex, data = lung_filtered)
ggsurvplot(lung_survfit, data = lung_filtered, risk.table = TRUE, pval = TRUE, conf.int = TRUE)
```
Проведем Лог-ранг тест

```{r}
survdiff(Surv(time, event) ~ sex, data = lung_filtered)
```

График выживаемости показывает, как изменяется доля выживших в зависимости от времени в зависимости от пола. Графики сближены, их доверительные интервалы пересекаются, что может говорить об отсутствии статистически значимых различий по полу. На это также указывает p-value = 0.1 (в самом графике посчиталось 0.13), который больше уровня значимости в 0.05, что говорит о том, что мы не можем отвергать нулевую гипотезу о том, что нет различий в выживаемости в зависимости от пола.


Построим график кумулятивной функции рисков (cumulative hazard function) для пола. 

```{r}
ggsurvplot(lung_survfit, fun = "cumhaz", conf.int = TRUE, risk.table = TRUE)
```

На графике видно, как изменяется риск в зависимости от времени. И опять доверительные интервалы двух групп, а так же линии графика пересекаются, что может говорить об отсутсвии значимых различий в уровне риска между полами.


С помощью функции coxph() построим регрессию Кокса для оценки влияние пола на выживаемость.

```{r}
cox_model = coxph(Surv(time, event) ~ sex, data = lung_filtered)

summary(cox_model)
```
По результату теста p-value = 0.136, что меньше уровня значимости в 0.05, что говорит о том, что мы не можем отклонить нулевую гипотезу об отсутствии разницы между полами.

Посчтиаем так же изменения риска на основе коэффициентов модели Кокса

```{r}
(1 - exp(coef(cox_model))) * 100
(exp(-coef(cox_model)) - 1) * 100
```
Риск смерти в группе женщин ниже, чем у мужчин на 22.21%, а риск смерти в группе мужчин выше на 28.5%. Однако, согласно тесту эти различия статистически не значимы. Результаты Likelihood ratio test, Wald test, Score (logrank) test так же указывают на отсутствие статистически значимой разницы.

Следует учитывать, что анализ был проведен только на пациентах, достигших целевого события, что не показывает статистической разницы ни по выживаемости, ни по уровню риска. Более целесообразно проводить полный анализ с учетом цензурированных данных.